/**
 * Core Philosophy: This ruleset enforces a security model based on user identity and collaborative roles.
 * Access is primarily granted to authenticated users. User data is strictly private, while shared data
 * like events is accessible to a defined list of administrators.
 *
 * Data Structure:
 * - /users/{userId}: Private user profiles, owned and accessible only by the user themselves.
 * - /events/{eventId}: Collaborative event documents. Access is controlled by an `adminUserIds` array within each document.
 * - /inventoryItems/{inventoryItemId}: A global collection of inventory. In this prototyping stage, all signed-in users can manage inventory.
 * - /inventoryItems/{inventoryItemId}/sales/{saleId}: Sales records nested under the inventory item they belong to, sharing the same access rules.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is granted explicitly.
 * - No User Enumeration: Listing documents in the top-level `/users` collection is disallowed to protect user privacy.
 * - Event Administration: Access to read or modify an event document is restricted to users whose UID is present in the document's `adminUserIds` array.
 * - Prototyping Flexibility for Inventory: To facilitate rapid development, management of the `/inventoryItems` collection and its `/sales` subcollections is currently permitted for any authenticated user. This should be refined with more specific roles as the application matures.
 *
 * Denormalization for Authorization: The `/events/{eventId}` documents use a denormalized `adminUserIds` array. This is a critical design choice that allows security rules to check for administrative permissions directly on the document being accessed, avoiding slow, costly, and sometimes impossible cross-document `get()` calls.
 *
 * Structural Segregation: User-private data is segregated in the `/users/{userId}` path, while collaborative and global data reside in their own top-level collections (`/events`, `/inventoryItems`), which simplifies rules and queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable, reusable logic
    /**
     * isSignedIn
     * @description Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
